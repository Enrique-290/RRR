<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>DINAMITA GYM POS</title>
<style>
:root{
  --bg:#ffffff;
  --fg:#111111;
  --muted:#707070;
  --red:#d61717;
  --red-600:#c50e0e;
  --red-700:#a50c0c;
  --border:#e9e9e9;
  --card:#fafafa;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
}
/* Layout */
.app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
.app.collapsed{grid-template-columns:64px 1fr;}
aside{
  background:var(--fg);
  color:#fff;
  position:sticky; top:0; height:100vh; overflow:auto;
}
.aside-header{
  display:flex;align-items:center;gap:.6rem;
  padding:1rem .9rem;border-bottom:1px solid #2a2a2a;
}
.logo-badge{
  width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
  background:var(--red);
  font-weight:800;
}
.brand{font-weight:800;letter-spacing:.5px}
.app.collapsed .brand{display:none}
.toggle{
  margin-left:auto;background:transparent;color:#fff;border:1px solid #444;
  border-radius:8px;padding:.35rem .55rem;cursor:pointer;
}
nav{padding:.5rem}
.link{
  display:flex;align-items:center;gap:.75rem;
  padding:.7rem .9rem;border-radius:12px;color:#ddd;text-decoration:none;
}
.link:hover{background:#1c1c1c;color:#fff}
.link.active{background:var(--red); color:#fff}
.icon{width:22px; height:22px; display:inline-grid; place-items:center; border-radius:6px; background:#303030; font-size:.95rem}
.app.collapsed .text{display:none}

/* Header */
header{
  background:var(--red);
  color:#fff;
  padding:1rem 1.25rem;
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; z-index:10;
}
h1{margin:0;font-size:1.15rem; letter-spacing:.3px}
.actions{display:flex; gap:.6rem; align-items:center}
.btn{
  border:0; background:#fff; color:var(--red-700);
  padding:.6rem .9rem; border-radius:10px; font-weight:700; cursor:pointer;
  box-shadow: 0 1px 0 rgba(0,0,0,.06);
}
.btn.outline{background:transparent;border:2px solid #fff;color:#fff}
.btn.ghost{background:transparent;color:#fff}
.btn:active{transform:translateY(1px)}

/* Main content */
main{padding:1rem 1.25rem;}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:1rem;
  box-shadow:0 1px 0 rgba(0,0,0,.03);
}
.grid{display:grid; gap:1rem}
.grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
.grid.cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
@media (max-width:920px){
  .grid.cols-3{grid-template-columns:1fr}
  .grid.cols-2{grid-template-columns:1fr}
}
.stat{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;background:#fff;border-radius:12px;border:1px solid var(--border)}
.stat .kpi{font-weight:800;font-size:1.3rem}
.stat .label{color:var(--muted);font-weight:600}

/* Floating footer buttons */
.footer-actions{
  position:fixed; bottom:14px; left:14px; right:14px; display:flex; gap:.8rem; justify-content:center; pointer-events:none;
}
.footer-actions .btn{pointer-events:auto; background:var(--red); color:#fff; border:0}
.footer-actions .btn.secondary{background:#111; color:#fff; border:1px solid #333}

/* Ticket 58mm preview */
.ticket{
  width: 280px; /* cerca de 58mm @ ~96dpi */
  background:#fff; border:1px dashed #ccc; padding:12px; border-radius:12px; margin:auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px; line-height:1.25;
}
.ticket h3{margin:.3rem 0; text-align:center}
.logo-box{
  width:100%; height:70px; border:1px dashed #ddd; border-radius:8px;
  display:grid; place-items:center; overflow:hidden; margin-bottom:.4rem; background:#fafafa;
}
.logo-box img{max-height:100%; max-width:100%; display:block}
hr.dot{border:0;border-top:1px dashed #bbb;margin:.5rem 0}
.right{text-align:right}
.center{text-align:center}

/* Forms */
.row{display:grid; gap:.7rem; grid-template-columns:1fr 1fr}
@media (max-width:800px){ .row{grid-template-columns:1fr} }
.input, select, textarea{
  width:100%; padding:.7rem .8rem; border:1px solid var(--border); border-radius:10px; background:#fff; color:#111;
}
label{font-size:.9rem; font-weight:700; color:#333}
.table{width:100%; border-collapse:collapse; font-size:.92rem}
.table th, .table td{border-bottom:1px solid var(--border); padding:.6rem .4rem; text-align:left}
.table th{color:#666; font-weight:700}
.badge{display:inline-block; padding:.25rem .5rem; border-radius:8px; font-size:.75rem; background:#eee}
.actions-cell button{margin-right:.4rem}
.hidden{display:none !important}
</style>
</head>
<body>
<div id="app" class="app">
  <aside>
    <div class="aside-header">
      <div class="logo-badge">DG</div>
      <div class="brand">DINAMITA GYM POS</div>
      <button class="toggle" id="toggleAside" title="Plegar men√∫">‚â°</button>
    </div>
    <nav id="nav">
      <a href="#/dashboard" class="link active"><span class="icon">üè†</span><span class="text">Dashboard</span></a>
      <a href="#/ventas" class="link"><span class="icon">üõí</span><span class="text">Ventas</span></a>
      <a href="#/inventario" class="link"><span class="icon">üì¶</span><span class="text">Inventario</span></a>
      <a href="#/clientes" class="link"><span class="icon">üë•</span><span class="text">Clientes</span></a>
      <a href="#/membresias" class="link"><span class="icon">üé´</span><span class="text">Membres√≠as</span></a>
      <a href="#/cafeteria" class="link"><span class="icon">‚òï</span><span class="text">Cafeter√≠a</span></a>
      <a href="#/historial" class="link"><span class="icon">üìú</span><span class="text">Historial</span></a>
      <a href="#/config" class="link"><span class="icon">‚öôÔ∏è</span><span class="text">Configuraci√≥n</span></a>
      <a href="#/ticket" class="link"><span class="icon">üßæ</span><span class="text">Ticket 58mm</span></a>
    </nav>
  </aside>

  <div>
    <header>
      <h1 id="title">Dashboard</h1>
      <div class="actions">
        <button class="btn" id="btnExport">Exportar respaldo</button>
        <button class="btn outline" id="btnImport">Importar respaldo</button>
      </div>
    </header>

    <main id="view">
      <!-- VISTAS -->
      <section id="v-dashboard" class="grid cols-2">
        <div class="card grid cols-2">
          <div class="stat"><div><div class="label">Ventas de hoy</div><div class="kpi" id="kpiVentas">$0.00</div></div><div>üíµ</div></div>
          <div class="stat"><div><div class="label">Tickets emitidos</div><div class="kpi" id="kpiTickets">0</div></div><div>üßæ</div></div>
          <div class="stat"><div><div class="label">Productos en stock</div><div class="kpi" id="kpiStock">0</div></div><div>üì¶</div></div>
          <div class="stat"><div><div class="label">Ganancia de hoy</div><div class="kpi" id="kpiProfit">$0.00</div></div><div>üìà</div></div>
        </div>
        <div class="card">
          <h3>Resumen</h3>
          <p>Bienvenido a <b>DINAMITA GYM POS</b>. Usa el men√∫ lateral para navegar.</p>
        </div>
      </section>

      <section id="v-ventas" class="hidden">
        <div class="card">
          <h3>Nueva venta</h3>
          <div class="row">
            <div>
              <label>Buscar producto</label>
              <input id="buscadorProd" class="input" placeholder="Nombre / SKU">
            </div>
            <div>
              <label>Cliente</label>
              <input id="clienteVenta" class="input" list="clientesList" placeholder="Venta al p√∫blico">
              <datalist id="clientesList"></datalist>
            </div>
          </div>
          <div style="margin-top:10px">
            <button class="btn" onclick="demoAgregar()">Agregar productos demo</button>
          </div>
          <hr class="dot">
          <div id="carrito"></div>
          <div class="row" style="margin-top:10px">
            <div><label>Notas del ticket</label><input id="notaTicket" class="input" placeholder="Gracias por tu compra en Dinamita üí•"></div>
            <div>
              <label>Totales</label>
              <div class="stat">
                <div>
                  <div class="label">Subtotal</div>
                  <div id="subtotal">$0.00</div>
                </div>
                <div class="right">
                  <div class="label">IVA(<span id="ivaPct">0</span>%)</div>
                  <div id="iva">$0.00</div>
                </div>
                <div class="right">
                  <div class="label">Total</div>
                  <div id="total" class="kpi">$0.00</div>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:.6rem">
            <button class="btn" onclick="confirmarVenta()">Confirmar venta</button>
            <button class="btn secondary" onclick="vaciarCarrito()">Vaciar</button>
          </div>
        </div>
      </section>

      <section id="v-inventario" class="hidden">
        <div class="card">
          <h3>Inventario</h3>
          <div class="row">
            <div><label>SKU</label><input id="sku" class="input" placeholder="SKU-001"></div>
            <div><label>Nombre</label><input id="nombreProd" class="input" placeholder="Producto"></div>
            <div><label>Categor√≠a</label>
              <select id="cat" class="input">
                <option>Suplementos</option><option>Accesorios</option><option>Cafeter√≠a</option><option>Membres√≠as</option>
              </select>
            </div>
            <div><label>Costo</label><input id="costo" type="number" class="input" placeholder="0"></div>
            <div><label>Precio</label><input id="precio" type="number" class="input" placeholder="0"></div>
            <div><label>Stock</label><input id="stock" type="number" class="input" placeholder="0"></div>
            <div><label>Imagen</label><input id="img" type="file" class="input" accept="image/*"></div>
            <div><label>&nbsp;</label><button class="btn" onclick="guardarProducto()">Guardar / Actualizar</button></div>
          </div>
          <hr class="dot">
          <table class="table" id="tablaInv">
            <thead><tr><th>SKU</th><th>Nombre</th><th>Cat</th><th>Precio</th><th>Stock</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="v-clientes" class="hidden">
        <div class="card">
          <h3>Clientes</h3>
          <div class="row">
            <div><label>Nombre</label><input id="nomCli" class="input" placeholder="Juan P√©rez"></div>
            <div><label>Tel√©fono</label><input id="telCli" class="input" placeholder="55..."></div>
            <div><label>Email</label><input id="mailCli" class="input" placeholder="correo@..."></div>
            <div><label>Certificado m√©dico</label>
              <select id="medCli" class="input"><option value="No">No</option><option value="S√≠">S√≠</option></select>
            </div>
            <div><label>Entrena por su cuenta</label>
              <select id="soloCli" class="input"><option value="No">No</option><option value="S√≠">S√≠</option></select>
            </div>
            <div><label>&nbsp;</label><button class="btn" onclick="guardarCliente()">Guardar / Actualizar</button></div>
          </div>
          <hr class="dot">
          <table class="table" id="tablaCli">
            <thead><tr><th>Nombre</th><th>Tel</th><th>Email</th><th>Med</th><th>Solo</th><th></th></tr></thead><tbody></tbody>
          </table>
        </div>
      </section>

      <section id="v-membresias" class="hidden">
        <div class="card">
          <h3>Registrar Membres√≠a</h3>
          <div class="row">
            <div><label>Cliente</label><input id="membCliente" class="input" list="clientesList" placeholder="Buscar cliente"></div>
            <div><label>Tipo</label>
              <select id="membTipo" class="input"><option>Visita</option><option>Semanal</option><option>Mensualidad</option></select>
            </div>
            <div><label>Inicio</label><input id="membInicio" type="date" class="input"></div>
            <div><label>Fin</label><input id="membFin" type="date" class="input"></div>
            <div><label>Notas</label><input id="membNotas" class="input" placeholder="VIP / Especial"></div>
            <div><label>&nbsp;</label><button class="btn" onclick="guardarMembresia()">Guardar</button></div>
          </div>
          <hr class="dot">
          <table class="table" id="tablaMemb">
            <thead><tr><th>Cliente</th><th>Tipo</th><th>Inicio</th><th>Fin</th><th>Estado</th></tr></thead><tbody></tbody>
          </table>
        </div>
      </section>

      <section id="v-cafeteria" class="hidden">
        <div class="card">
          <h3>Cafeter√≠a</h3>
          <p>Los productos con categor√≠a <b>Cafeter√≠a</b> se listan aqu√≠ para venta r√°pida.</p>
          <div id="cardsCafe" class="grid cols-3"></div>
        </div>
      </section>

      <section id="v-historial" class="hidden">
        <div class="card">
          <h3>Historial de ventas</h3>
          <div class="row">
            <div><label>Desde</label><input type="date" id="f1" class="input"></div>
            <div><label>Hasta</label><input type="date" id="f2" class="input"></div>
            <div><label>&nbsp;</label><button class="btn" onclick="filtrarHistorial()">Filtrar</button></div>
          </div>
          <hr class="dot">
          <table class="table" id="tablaHist">
            <thead><tr><th>Folio</th><th>Fecha</th><th>Cliente</th><th>Total</th><th></th></tr></thead><tbody></tbody>
          </table>
        </div>
      </section>

      <section id="v-config" class="hidden">
        <div class="card">
          <h3>Configuraci√≥n</h3>
          <div class="row">
            <div><label>IVA (%)</label><input id="cfgIVA" type="number" class="input" value="0"></div>
            <div><label>Nombre negocio</label><input id="cfgNombre" class="input" placeholder="DINAMITA GYM POS"></div>
            <div><label>Mensaje final</label><input id="cfgMsg" class="input" placeholder="¬°Gracias por tu compra!"></div>
            <div><label>Direcci√≥n</label><input id="cfgDir" class="input" placeholder="Calle, Colonia, CP"></div>
            <div><label>Tel√©fono</label><input id="cfgTel" class="input" placeholder="55..."></div>
            <div><label>Web</label><input id="cfgWeb" class="input" placeholder="https://"></div>
            <div><label>Logo (58mm ancho aprox.)</label><input id="cfgLogo" type="file" class="input" accept="image/*"></div>
            <div><label>&nbsp;</label><button class="btn" onclick="guardarCfg()">Guardar</button></div>
          </div>
        </div>
      </section>

      <section id="v-ticket" class="hidden">
        <div class="card">
          <h3>Vista previa de ticket 58mm</h3>
          <div class="ticket" id="ticket">
            <div class="logo-box"><img id="tLogo" alt="Logo"></div>
            <h3 id="tNombre">DINAMITA GYM POS</h3>
            <div class="center" id="tDirTel"></div>
            <hr class="dot">
            <div id="tCuerpo">
              <div class="center">Ticket de venta</div>
              <div>Folio: <span id="tFolio">‚Äî</span></div>
              <div>Fecha: <span id="tFecha">‚Äî</span></div>
              <div>Cliente: <span id="tCliente">Venta al p√∫blico</span></div>
              <hr class="dot">
              <div id="tItems">‚Äî</div>
              <hr class="dot">
              <div class="right">SUBTOTAL <span id="tSub">$0.00</span></div>
              <div class="right">IVA <span id="tIVA">$0.00</span></div>
              <div class="right"><b>TOTAL <span id="tTot">$0.00</span></b></div>
            </div>
            <hr class="dot">
            <div class="center" id="tMsg">¬°Gracias por tu compra!</div>
          </div>
          <div style="text-align:center;margin-top:10px">
            <button class="btn" onclick="imprimir()">Imprimir</button>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<div class="footer-actions">
  <button class="btn secondary" onclick="exportarVentasCSV()">Exportar ventas (CSV)</button>
  <button class="btn" onclick="exportarVentasPDF()">Exportar ventas (PDF)</button>
</div>

<script>
const $ = (sel)=>document.querySelector(sel);
const app = $('#app');
$('#toggleAside').onclick = ()=> app.classList.toggle('collapsed');

// Router simple
const routes = ['dashboard','ventas','inventario','clientes','membresias','cafeteria','historial','config','ticket'];
function show(route){
  routes.forEach(r=> $('#v-'+r).classList.add('hidden'));
  $('#v-'+route).classList.remove('hidden');
  $('#title').textContent = route.charAt(0).toUpperCase()+route.slice(1);
  document.querySelectorAll('nav .link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')==='#/'+route));
}
window.addEventListener('hashchange', ()=>{
  const r = location.hash.replace('#/','')||'dashboard';
  if(routes.includes(r)) show(r);
});
show((location.hash.replace('#/',''))||'dashboard');

// Datos (localStorage)
const LS = {
  get(k, d){ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch(e){return d}},
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
};
const state = {
  cfg: LS.get('cfg', {iva:0, nombre:'DINAMITA GYM POS', msg:'¬°Gracias por tu compra!', dir:'', tel:'', web:'', logo:null}),
  inv: LS.get('inv', []),
  cli: LS.get('cli', [{nombre:'Venta al p√∫blico', tel:'', email:'', med:'No', solo:'No'}]),
  ventas: LS.get('ventas', []),
  memb: LS.get('memb', []),
  carrito: [],
};

function persist(){ LS.set('cfg',state.cfg); LS.set('inv',state.inv); LS.set('cli',state.cli); LS.set('ventas',state.ventas); LS.set('memb',state.memb) }

// UI Inicial
function renderAll(){
  // KPI
  $('#kpiStock').textContent = state.inv.reduce((a,b)=>a+Number(b.stock||0),0);
  // Clientes datalist
  const dl = $('#clientesList'); dl.innerHTML='';
  state.cli.forEach(c=>{ const o=document.createElement('option'); o.value=c.nombre; dl.appendChild(o); });
  // Inventario tabla
  const tb = $('#tablaInv tbody'); tb.innerHTML='';
  state.inv.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.sku||''}</td><td>${p.nombre}</td><td>${p.cat}</td><td>$${Number(p.precio||0).toFixed(2)}</td><td>${p.stock||0}</td>
    <td class="actions-cell"><button class="btn" onclick="editarProd(${i})">Editar</button><button class="btn secondary" onclick="borrarProd(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
  // Clientes tabla
  const tbc = $('#tablaCli tbody'); tbc.innerHTML='';
  state.cli.forEach((c,i)=>{
    if(i===0) return; // omitir Venta al p√∫blico
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${c.nombre}</td><td>${c.tel||''}</td><td>${c.email||''}</td><td><span class="badge">${c.med}</span></td><td><span class="badge">${c.solo}</span></td>
    <td class="actions-cell"><button class="btn" onclick="editarCli(${i})">Editar</button><button class="btn secondary" onclick="borrarCli(${i})">Borrar</button></td>`;
    tbc.appendChild(tr);
  });
  // Membres√≠as tabla
  const tbm = $('#tablaMemb tbody'); tbm.innerHTML='';
  state.memb.forEach(m=>{
    const hoy=new Date().toISOString().slice(0,10);
    const est = (m.fin>=hoy)?'Activa':'Vencida';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${m.cliente}</td><td>${m.tipo}</td><td>${m.inicio}</td><td>${m.fin}</td><td><span class="badge">${est}</span></td>`;
    tbm.appendChild(tr);
  });
  // Cafeter√≠a cards
  const cafe = state.inv.filter(p=>p.cat==='Cafeter√≠a');
  const cont = $('#cardsCafe'); cont.innerHTML='';
  cafe.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `<b>${p.nombre}</b><div class="muted">$${Number(p.precio||0).toFixed(2)}</div>
      <div style="margin-top:8px"><button class="btn" onclick="agregarAlCarrito('${p.sku}')">Agregar</button></div>`;
    cont.appendChild(div);
  });
  // Config en ticket
  applyTicketCfg();
}
renderAll();

// Guardar CFG
$('#cfgLogo').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const b64 = await toBase64(file);
  state.cfg.logo = b64; persist(); applyTicketCfg();
});
function guardarCfg(){
  state.cfg.iva = Number($('#cfgIVA').value)||0;
  state.cfg.nombre = $('#cfgNombre').value||'DINAMITA GYM POS';
  state.cfg.msg = $('#cfgMsg').value||'¬°Gracias por tu compra!';
  state.cfg.dir = $('#cfgDir').value||'';
  state.cfg.tel = $('#cfgTel').value||'';
  state.cfg.web = $('#cfgWeb').value||'';
  persist(); applyTicketCfg(); alert('Configuraci√≥n guardada.');
}
function applyTicketCfg(){
  $('#ivaPct').textContent = state.cfg.iva;
  $('#tNombre').textContent = state.cfg.nombre;
  $('#tMsg').textContent = state.cfg.msg;
  $('#tDirTel').textContent = [state.cfg.dir, state.cfg.tel, state.cfg.web].filter(Boolean).join(' ‚Ä¢ ');
  $('#tLogo').src = state.cfg.logo || '';
}

// Inventario CRUD
async function toBase64(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }) }
function guardarProducto(){
  const p = { sku:$('#sku').value.trim(), nombre:$('#nombreProd').value.trim(), cat:$('#cat').value,
              costo:Number($('#costo').value)||0, precio:Number($('#precio').value)||0, stock:Number($('#stock').value)||0, img:$('#img').dataset.b64||null };
  const idx = state.inv.findIndex(x=>x.sku===p.sku);
  if(idx>=0) state.inv[idx]=p; else state.inv.push(p);
  persist(); renderAll(); alert('Producto guardado');
}
$('#img').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return; $('#img').dataset.b64 = await toBase64(f);
});
function editarProd(i){
  const p = state.inv[i];
  $('#sku').value=p.sku; $('#nombreProd').value=p.nombre; $('#cat').value=p.cat; $('#costo').value=p.costo; $('#precio').value=p.precio; $('#stock').value=p.stock;
}
function borrarProd(i){ if(confirm('¬øBorrar producto?')){ state.inv.splice(i,1); persist(); renderAll(); } }

// Clientes CRUD
function guardarCliente(){
  const c = { nombre:$('#nomCli').value.trim(), tel:$('#telCli').value.trim(), email:$('#mailCli').value.trim(),
              med:$('#medCli').value, solo:$('#soloCli').value };
  const idx = state.cli.findIndex(x=>x.nombre===c.nombre);
  if(idx>=0) state.cli[idx]=c; else state.cli.push(c);
  persist(); renderAll(); alert('Cliente guardado');
}
function editarCli(i){
  const c = state.cli[i];
  $('#nomCli').value=c.nombre; $('#telCli').value=c.tel; $('#mailCli').value=c.email; $('#medCli').value=c.med; $('#soloCli').value=c.solo;
}
function borrarCli(i){ if(confirm('¬øBorrar cliente?')){ state.cli.splice(i,1); persist(); renderAll(); } }

// Ventas / Carrito
function demoAgregar(){
  // agrega algunos productos demo (si no existen)
  const seed=[
    {sku:'WHEY-CH-900', nombre:'Prote√≠na Whey 900g', cat:'Suplementos', costo:300, precio:650, stock:10},
    {sku:'SHAKER-700', nombre:'Shaker 700ml', cat:'Accesorios', costo:60, precio:120, stock:25},
    {sku:'CAFE-AMER', nombre:'Caf√© americano', cat:'Cafeter√≠a', costo:8, precio:35, stock:99},
    {sku:'MENSUAL-001', nombre:'Mensualidad', cat:'Membres√≠as', costo:0, precio:500, stock:999},
  ];
  seed.forEach(p=>{ if(!state.inv.find(x=>x.sku===p.sku)) state.inv.push(p); });
  persist(); renderAll();
  ['WHEY-CH-900','SHAKER-700','CAFE-AMER'].forEach(agregarAlCarrito);
}
function agregarAlCarrito(sku){
  const p = state.inv.find(x=>x.sku===sku); if(!p) return;
  const item = state.carrito.find(i=>i.sku===sku);
  if(item) item.cant++; else state.carrito.push({sku:p.sku, nombre:p.nombre, precio:p.precio, cant:1, cat:p.cat});
  pintarCarrito();
}
function pintarCarrito(){
  const div = $('#carrito');
  if(state.carrito.length===0){ div.innerHTML='<i>Carrito vac√≠o</i>'; calcTotales(); return; }
  div.innerHTML = '<table class="table"><thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th><th></th></tr></thead><tbody>'+
    state.carrito.map((i,idx)=>`<tr><td>${i.nombre}</td><td>${i.cant}</td><td>$${i.precio.toFixed(2)}</td><td>$${(i.cant*i.precio).toFixed(2)}</td><td><button class="btn secondary" onclick="remItem(${idx})">Quitar</button></td></tr>`).join('')+
    '</tbody></table>';
  calcTotales();
}
function remItem(idx){ state.carrito.splice(idx,1); pintarCarrito(); }
function vaciarCarrito(){ state.carrito=[]; pintarCarrito(); }
function calcTotales(){
  const sub = state.carrito.reduce((a,i)=>a+i.cant*i.precio,0);
  const iva = sub * (state.cfg.iva/100);
  const tot = sub + iva;
  $('#subtotal').textContent = money(sub);
  $('#iva').textContent = money(iva);
  $('#total').textContent = money(tot);
}
function money(n){ return '$'+(Number(n)||0).toFixed(2) }

function confirmarVenta(){
  if(state.carrito.length===0) return alert('Carrito vac√≠o');
  const folio = genFolio();
  const fecha = new Date();
  const cliente = $('#clienteVenta').value.trim() || 'Venta al p√∫blico';
  const nota = $('#notaTicket').value.trim();
  // Si incluye membres√≠a, calcular vigencia de 30 d√≠as
  let vigencia = null;
  if(state.carrito.some(i=>i.cat==='Membres√≠as')){
    const inicio = fecha.toISOString().slice(0,10);
    const fin = new Date(fecha.getTime()+30*86400000).toISOString().slice(0,10);
    vigencia = {inicio, fin};
  }
  const venta = {
    folio, fecha: fecha.toISOString(), cliente,
    items: JSON.parse(JSON.stringify(state.carrito)),
    sub: state.carrito.reduce((a,i)=>a+i.cant*i.precio,0),
    iva: state.carrito.reduce((a,i)=>a+i.cant*i.precio,0)*(state.cfg.iva/100),
    total: 0,
    nota, vigencia
  };
  venta.total = venta.sub + venta.iva;
  state.ventas.push(venta);
  persist();
  // pintar ticket
  fillTicket(venta);
  location.hash = '#/ticket';
  // vaciar carrito
  state.carrito=[]; pintarCarrito();
  alert('Venta registrada. Folio '+folio);
}

function fillTicket(v){
  $('#tFolio').textContent = v.folio;
  $('#tFecha').textContent = new Date(v.fecha).toLocaleString();
  $('#tCliente').textContent = v.cliente || 'Venta al p√∫blico';
  $('#tItems').innerHTML = v.items.map(it=>`${it.cant}x ${it.nombre} <span class="right">$${(it.cant*it.precio).toFixed(2)}</span>`).join('<br>');
  $('#tSub').textContent = money(v.sub);
  $('#tIVA').textContent = money(v.iva);
  $('#tTot').textContent = money(v.total);
  if(v.vigencia){
    const row = document.createElement('div');
    row.className='center';
    row.textContent = `Vigencia: ${v.vigencia.inicio} ‚Üí ${v.vigencia.fin}`;
    $('#tCuerpo').insertBefore(row, $('#tCuerpo').querySelector('.right'));
  }
}

// Historial con reimpresi√≥n
function filtrarHistorial(){
  const d1 = $('#f1').value||'0000-01-01';
  const d2 = $('#f2').value||'9999-12-31';
  const tb = $('#tablaHist tbody'); tb.innerHTML='';
  state.ventas.filter(v=> v.fecha.slice(0,10)>=d1 && v.fecha.slice(0,10)<=d2 )
    .forEach(v=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${v.folio}</td><td>${new Date(v.fecha).toLocaleString()}</td><td>${v.cliente||'Venta al p√∫blico'}</td><td>$${v.total.toFixed(2)}</td>
      <td><button class="btn" onclick='reimprimir("${v.folio}")'>Reimprimir</button></td>`;
      tb.appendChild(tr);
    });
}
function reimprimir(folio){
  const v = state.ventas.find(x=>x.folio===folio);
  if(!v) return alert('No encontrado');
  fillTicket(v);
  location.hash = '#/ticket';
}

// Export/Import respaldo
$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify({cfg:state.cfg, inv:state.inv, cli:state.cli, ventas:state.ventas, memb:state.memb}, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='respaldo-dinamita.json'; a.click();
};
$('#btnImport').onclick = async ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{
    const file = inp.files[0]; if(!file) return;
    const text = await file.text();
    try{ const data = JSON.parse(text);
      state.cfg=data.cfg||state.cfg; state.inv=data.inv||[]; state.cli=data.cli||state.cli; state.ventas=data.ventas||[]; state.memb=data.memb||[];
      persist(); renderAll(); alert('Respaldo importado');
    }catch(e){ alert('Archivo inv√°lido'); }
  };
  inp.click();
};

// Exportaci√≥n ventas
function exportarVentasCSV(){
  const rows = [['Folio','Fecha','Cliente','Producto','Cant','Precio','Total','Categor√≠a']];
  state.ventas.forEach(v=>{
    v.items.forEach(i=> rows.push([v.folio, v.fecha, v.cliente||'Venta al p√∫blico', i.nombre, i.cant, i.precio, i.cant*i.precio, i.cat]));
  });
  const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',') ).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='ventas.csv'; a.click();
}
function exportarVentasPDF(){
  // Se abre una ventana con reporte contable (para imprimir como PDF)
  const w = window.open('', '_blank');
  const porCat = {};
  state.ventas.forEach(v=> v.items.forEach(i=>{
    porCat[i.cat] = porCat[i.cat] || {subtotal:0, filas:[]};
    porCat[i.cat].subtotal += i.cant*i.precio;
    porCat[i.cat].filas.push([v.folio, new Date(v.fecha).toLocaleString(), v.cliente||'Venta al p√∫blico', i.nombre, i.cant, i.precio, i.cant*i.precio]);
  }));
  const secciones = Object.entries(porCat).map(([cat, obj])=>`
    <h3>${cat}</h3>
    <table border="1" cellspacing="0" cellpadding="4" style="width:100%; border-collapse:collapse; font-family:Arial; font-size:12px">
      <thead><tr><th>Folio</th><th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th></tr></thead>
      <tbody>${obj.filas.map(f=>`<tr>${f.map(td=>`<td>${td}</td>`).join('')}</tr>`).join('')}</tbody>
    </table>
    <p style="text-align:right"><b>Subtotal ${cat}:</b> $${obj.subtotal.toFixed(2)}</p>
  `).join('');
  w.document.write(`<!doctype html><meta charset="utf-8"><title>Reporte de ventas</title>
  <style>h1{font-family:Arial} .muted{color:#666}</style>
  <h1>${state.cfg.nombre} ‚Äî Reporte de ventas</h1>
  <div class="muted">${new Date().toLocaleString()}</div>
  ${secciones}
  <hr><p style="text-align:right"><i>Tip: usa Imprimir ‚Üí Guardar como PDF</i></p>`);
  w.focus();
}

// Ticket print
function imprimir(){
  const win = window.open('', '_blank', 'width=400,height=600');
  const el = $('#ticket').outerHTML;
  win.document.write(`<!doctype html><meta charset="utf-8"><title>Ticket</title>
  <style>
    body{margin:0; padding:10px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px}
    .ticket{width:280px}
    .logo-box img{max-width:100%; max-height:70px}
    hr{border:0;border-top:1px dashed #bbb;margin:.5rem 0}
    .right{text-align:right}.center{text-align:center}
  </style>
  ${el}
  <script>window.onload=()=>setTimeout(()=>window.print(),150)</script>`);
  win.document.close();
}

// Folio helper
function genFolio(){
  return 'T'+Math.random().toString(36).slice(2,8).toUpperCase();
}

// Navegaci√≥n inicial hash
if(!location.hash) location.hash = '#/dashboard';
</script>
</body>
</html>
